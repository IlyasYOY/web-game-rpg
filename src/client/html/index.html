<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/client/js/Menu.js"></script>
    <script src="/client/js/buttons_keys.js"></script>
    <script src="/client/js/MapHandler.js"></script>
    <script src="/client/js/Fight.js"></script>
    <script src="/client/js/FightMenu.js"></script>
    <script src="/common/js/Map.js"></script>
    <script src="/common/js/Player.js"></script>
    <style>
        canvas {
            border: 1px solid black;
        }

        #miniMap {
            vertical-align: top;
        }

        #chat {
            width: 200px; /* ширина нашего блока */
            height: 125px; /* высота нашего блока */
            background: #fff; /* цвет фона, белый */
            border: 1px solid black; /* размер и цвет границы блока */
            overflow: auto; /* свойство для прокрутки по горизонтали. Автоматом, если больше блока */
        }

        #inputToChat{
            width: 200px; /* ширина нашего блока */
            height: 25px; /* высота нашего блока */
            background: #fff; /* цвет фона, белый */
            border: 1px solid black; /* размер и цвет границы блока */
        }

        input{
            width: 100%;
        }

    </style>
</head>
<body>
<div align="left">
    <canvas style="float: left;" id="canvas"></canvas>


    <div style="float: left;">
        <canvas style="float: left" id="miniMap"></canvas>
        <div style="float: none;">
            <canvas style="float: none" id="inv"></canvas>
            <form>
            <div style="float: none;" id="chat">
                chat
            </div>
            <input style="float: none;" id="inputToChat" type="text"/>
                <div>
                <input type="submit" />
                </div>
            </form>
        </div>
    </div>
</div>
<!--<div>-->
<!--&lt;!&ndash;<canvas id="miniMap"></canvas>&ndash;&gt;-->
<!--&lt;!&ndash;<canvas id="inventory"></canvas>&ndash;&gt;-->
<!--</div>-->


<script>
    mapSize = 20;
    let map = new Map(mapSize);

    for (let k = 15; k < 20; ++k) {
        for (let d = 15; d < 20; ++d) {
            map.setCell(k, d, -1);
        }
    }

    for (let k = 5; k < 7; ++k) {
        for (let d = 5; d < 7; ++d) {
            map.setCell(k, d, 1);
        }
    }

    map.setCell(3, 4, 2);
    map.setCell(1, 3, 3);

    for (let k = 4; k < 7; ++k) {
        for (let d = 0; d < 3; ++d) {
            map.setCell(k, d, 4);
        }
    }

    for (let k = 2; k < 5; ++k) {
        for (let d = 13; d < 15; ++d) {
            map.setCell(k, d, -2);
        }
    }


</script>


<script type="text/javascript">



    let whereAmI = 'Menu';
    let myPlayer = 0;
    let myEnemy = -1;

    let canvasWidth = 600;
    let canvasHeight = 600;
    let miniMapWidth = canvasWidth / 3;
    let miniMapHeight = canvasHeight / 3;
    let inventoryWidth = canvasWidth / 3;
    let inventoryHeight = canvasHeight / 3;
    let chatSize = inventoryHeight;
    let numbersOfCell = 10;
    let sizeOfCell = canvasHeight / numbersOfCell;
    let inventory = document.getElementById('inv');
    let inventoryContext = inventory.getContext('2d');
    let canvas = document.getElementById('canvas');
    let canvasContext = canvas.getContext('2d');
    let miniMap = document.getElementById('miniMap');
    let miniMapContext = miniMap.getContext('2d');
    let chat = document.getElementById('chat');
    chat.height = chatSize;
    chat.width = chatSize;
    chat.style.overflow = 'auto';
    canvas.height = canvasHeight;
    canvas.width = canvasWidth;
    miniMap.height = miniMapHeight;
    miniMap.width = miniMapWidth;
    inventory.height = inventoryHeight;
    inventory.width = inventoryWidth;

    let camera = {
        startX: 0,
        startY: 0
    };

    let mauseCoord = {
        x: 0,
        y: 0,
        isDown: false
    };

    let clickedSells = {
        x: -1,
        y: -1
    };

//    var playerOne = new Player(0, 0, 0, 10);
    var playerTwo = new Player(3, 0, 0, 10);
//    var playerThree = new Player(0, 3, 0, 15);
    var players;
//    = [playerOne, playerTwo, playerThree];

    var myPerson = playerTwo;
//        = playerOne;

    var socket = io.connect();

    socket.on("get_player",function (player) {
        myPerson = JSON.parse(player);
        console.log(myPerson);
    });

    socket.on("get_map",function (mMap) {
        map = JSON.parse(mMap);
        console.log('get_map');
    });

    setInterval(function () {
        socket.on("who_moves",function (id) {
            if(socket.id == id){
                if (whereAmI === "Wait"){
                        whereAmI = "Map";}
            } else {
                //здесь должна быть другая реализация
                whereAmI = "Wait";
            }
        });

        socket.on('get_players',function (mPlayers) {
            players = mPlayers;
        });

        socket.on("game_stage",function (wh) {
            WhereAmI = wh.stage;
            myEnemy = wh.from;
        });

        canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
        if (whereAmI === 'Menu') {
            menuHandler();
        } else if(whereAmI === 'FightMenu'){
            fightMenuHandler();
        } else if (whereAmI === 'Map') {
            toMap();
        } else if (whereAmI === 'Fight') {
            fightHandler(myPlayer, myEnemy);
        } else if (whereAmI === 'Wait') {
            canvasContext.font="20px Georgia";
            canvasContext.fillStyle = "#000000";
            canvasContext.fillText('Please Wait',300,300);
        }
    }, 1000 / 60);

    canvas.onmousemove = function (event) {
        mauseCoord.x = event.pageX;
        mauseCoord.y = event.pageY;
        console.log(mauseCoord.x + ' / ' + mauseCoord.y)
    };

    canvas.onclick = function (event) {
        mauseCoord.isDown = true;
    };

    inventory.onmousemove = function (event) {
        mauseCoord.x = event.pageX;
        mauseCoord.y = event.pageY;
        console.log(mauseCoord.x + ' / ' + mauseCoord.y)
    };

    inventory.onclick = function (event) {
        mauseCoord.isDown = true;
    };

    //    miniMap.onmousemove = function (event) {
    //        mauseCoord.x = event.pageX;
    //        mauseCoord.y = event.pageY;
    //        console.log(mauseCoord.x + ' / ' + mauseCoord.y)
    //    };
    //
    //    miniMap.onclick = function (event) {
    //        mauseCoord.isDown = true;
    //    };

    window.onkeyup = function (event) {
        setKeyUp(event.keyCode);
    };

    window.onkeydown = function (event) {
        setKeyPush(event.keyCode);
    };
</script>
</body>
</html>