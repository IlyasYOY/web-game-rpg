<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/client/js/SuperVisor.js"></script>
    <script src="/client/js/Menu.js"></script>
    <script src="/client/js/buttons_keys.js"></script>
    <script src="/client/js/MapHandler.js"></script>
    <script src="/client/js/Fight.js"></script>
    <script src="/client/js/FightMenu.js"></script>
    <script src="/common/js/Map.js"></script>
    <script src="/common/js/Player.js"></script>
    <script src="/client/js/FindPath.js"></script>
    <style>
        canvas {
            border: 1px solid black;
        }
        #miniMap {
            vertical-align: top;
        }
        #chat {
            width: 200px;
            /* ширина нашего блока */
            height: 125px;
            /* высота нашего блока */
            background: #fff;
            /* цвет фона, белый */
            border: 1px solid black;
            /* размер и цвет границы блока */
            overflow: auto;
            /* свойство для прокрутки по горизонтали. Автоматом, если больше блока */
        }
        #inputToChat {
            width: 200px;
            /* ширина нашего блока */
            height: 25px;
            /* высота нашего блока */
            background: #fff;
            /* цвет фона, белый */
            border: 1px solid black;
            /* размер и цвет границы блока */
        }
        input {
            width: 100%;
        }
    </style>
</head>

<body>
<div align="left">
    <canvas style="float: left;" id="canvas"></canvas>


    <div style="float: left;">
        <canvas style="float: left" id="miniMap"></canvas>
        <div style="float: none;">
            <canvas style="float: none" id="inv"></canvas>
            <div style="float: none;" id="chat">
                <ul id="messages">

                </ul>
            </div>
            <input style="float: none;" id="inputToChat" type="text" />
            <div>
                <input type="submit" id="send-button"/>
            </div>
        </div>
    </div>
</div>
<!--<div>-->
<!--&lt;!&ndash;<canvas id="miniMap"></canvas>&ndash;&gt;-->
<!--&lt;!&ndash;<canvas id="inventory"></canvas>&ndash;&gt;-->
<!--</div>-->


<script>
    //new Map(mapSize);
    //
    //    for (let k = 15; k < 20; ++k) {
    //        for (let d = 15; d < 20; ++d) {
    //            map.setCell(k, d, -1);
    //        }
    //    }
    //
    //    for (let k = 5; k < 7; ++k) {
    //        for (let d = 5; d < 7; ++d) {
    //            map.setCell(k, d, 1);
    //        }
    //    }
    //
    //    map.setCell(3, 4, 2);
    //    map.setCell(1, 3, 3);
    //
    //    for (let k = 4; k < 7; ++k) {
    //        for (let d = 0; d < 3; ++d) {
    //            map.setCell(k, d, 4);
    //        }
    //    }
    //
    //    for (let k = 2; k < 5; ++k) {
    //        for (let d = 13; d < 15; ++d) {
    //            map.setCell(k, d, -2);
    //        }
    //    }
</script>

<script>

</script>


<script type="text/javascript">
    let whereAmI = 'Wait';
    let myEnemy = -1;
    let canvasWidth = 600;
    let canvasHeight = 600;
    let miniMapWidth = canvasWidth / 3;
    let miniMapHeight = canvasHeight / 3;
    let inventoryWidth = canvasWidth / 3;
    let inventoryHeight = canvasHeight / 3;
    let chatSize = inventoryHeight;
    let numbersOfCell = 10;
    let sizeOfCell = canvasHeight / numbersOfCell;
    let inventory = document.getElementById('inv');
    let inventoryContext = inventory.getContext('2d');
    let canvas = document.getElementById('canvas');
    let canvasContext = canvas.getContext('2d');
    let miniMap = document.getElementById('miniMap');
    let miniMapContext = miniMap.getContext('2d');
    let chat = document.getElementById('chat');
    let sendButton = document.getElementById('send-button');
    let inputToChat = document.getElementById('inputToChat');
    let messagesList = document.getElementById("messages");
    chat.height = chatSize;
    chat.width = chatSize;
    chat.style.overflow = 'auto';
    canvas.height = canvasHeight;
    canvas.width = canvasWidth;
    miniMap.height = miniMapHeight;
    miniMap.width = miniMapWidth;
    inventory.height = inventoryHeight;
    inventory.width = inventoryWidth;
    let camera = {
        startX: 0,
        startY: 0
    };
    let mauseCoord = {
        x: 0,
        y: 0,
        isDown: false
    };
    let clickedSells = {
        x: -1,
        y: -1,
        isDoubleClick: false
    };
    //    var playerOne = new Player(0, 0, 0, 10);
    //    var playerTwo = new Player(3, 0, 0, 10);
    //    var playerThree = new Player(0, 3, 0, 15);
    var map;
    var playersLimit;
    var players;
    //    = [playerOne, playerTwo, playerThree];
    var myPerson;
    var mapBonus;
    //        = playerTwo;
    var socket = io.connect();
    sendButton.onclick = function() {
        socket.emit("message_sent", inputToChat.value);
        inputToChat.value = '';
    };
    socket.on("message_sent", function(data) {
        let newLi = document.createElement("li");
        newLi.innerText = data;
        messagesList.appendChild(newLi)
    });
    socket.on("get_player", function (player) {
        myPerson = player;
    });
    socket.on('get_players', function (mPlayers) {
        players = mPlayers;
    });
    socket.emit("emit_get_map");
    socket.on("get_map", function (mMap) {
        map = JSON.parse(mMap);
    });
    socket.on("get_players_limit", function (limit) {
        playersLimit = limit;
    });
    socket.on("game_stage", function (wh) {
        whereAmI = wh.stage;
        myEnemy = wh.from;
    });
    socket.on("who_moves", function (id) {
        if (socket.id == id) {
            if (whereAmI === 'Wait') {
                whereAmI = 'Map';
            }
        } else {
            if (whereAmI !== 'Supervisor') {
                whereAmI = 'Wait';
            }
        }
    });
    socket.on("who_moves_fight", function (id) {
        whoMoves = id;
    });
    socket.on("fight_chose_unit", function (unit) {
        clickedUnit.unit = unit;
        clickedUnit.x = myPersonUnitsCoord[unit].x;
        clickedUnit.y = myPersonUnitsCoord[unit].y;
        clickedUnit.heightUnit = myPersonUnitsCoord[unit].height;
        clickedUnit.widthUnit = myPersonUnitsCoord[unit].width;
    });
    socket.on("fight_chose_skill", function (skill) {
        clickedSkills = skill;
    });
    socket.on("fight_attack_was_made", function () {
        clearChose();
    });

    socket.on("get_bonus", function (bonus) {
        mapBonus = bonus;
    });
    setInterval(function () {
        socket.emit("emit_get_players");
        socket.emit("emit_get_bonus");
        canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
        if (whereAmI === 'Wait') {
            canvas.style.opacity = "0.5";
            drawMySkills(myPerson);
            reloadMainMap();
            canvasContext.font = "20px Georgia";
            canvasContext.fillStyle = "#000000";
            canvasContext.fillText('Please Wait', 250, 300);
            reloadMiniMap();
        } else {
            canvas.style.opacity = "1";
            if (whereAmI === 'Menu') {
                menuHandler();
            } else if (whereAmI === 'FightMenu') {
                fightMenuHandler();
            } else if (whereAmI === 'Map') {
                toMap();
            } else if (whereAmI === 'Fight') {
                reloadMiniMap();
                fightHandler(myEnemy);
            } else if (whereAmI === 'Supervisor') {
                reloadMiniMapForSuperVisor();
                toMap();
            }else if (whereAmI === 'Win') {
                canvasContext.font = "20px Georgia";
                canvasContext.fillStyle = "#000000";
                canvasContext.fillText('YOU WIN', 250, 300);
            }
        }
    }, 1000 / 60);
    canvas.onmousemove = function (event) {
        mauseCoord.x = event.pageX;
        mauseCoord.y = event.pageY;
    };
    canvas.onclick = function (event) {
        mauseCoord.isDown = true;
    };
    inventory.onmousemove = function (event) {
        mauseCoord.x = event.pageX;
        mauseCoord.y = event.pageY;
    };
    inventory.onclick = function (event) {
        mauseCoord.isDown = true;
    };
    //    miniMap.onmousemove = function (event) {
    //        mauseCoord.x = event.pageX;
    //        mauseCoord.y = event.pageY;
    //        console.log(mauseCoord.x + ' / ' + mauseCoord.y)
    //    };
    //
    //    miniMap.onclick = function (event) {
    //        mauseCoord.isDown = true;
    //    };
    window.onkeyup = function (event) {
        setKeyUp(event.keyCode);
    };
    window.onkeydown = function (event) {
        setKeyPush(event.keyCode);
    };
</script>
</body>

</html>